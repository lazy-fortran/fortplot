name: Downstream Integration Test

on:
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cmake-fetchcontent:
    name: CMake FetchContent
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4

    - name: Cache and install apt packages
      uses: awalsh128/cache-apt-pkgs-action@v1.5.3
      with:
        packages: gfortran cmake ninja-build
        version: 1

    - name: Test CMake FetchContent integration
      run: |
        cd example/user_compilation_examples/cmake_project_template
        cmake -S . -B build -G Ninja
        cmake --build build
        ./build/bin/fortplot_demo

    - name: Verify CMake demo outputs
      run: |
        cd example/user_compilation_examples/cmake_project_template
        ls -la cmake_*.png cmake_*.pdf cmake_*.txt

  fpm-dependency:
    name: FPM Dependency
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4

    - name: Cache and install apt packages
      uses: awalsh128/cache-apt-pkgs-action@v1.5.3
      with:
        packages: gfortran
        version: 1

    - name: Setup FPM
      run: |
        for i in 1 2 3; do
          echo "FPM download attempt $i"
          if wget --timeout=30 --tries=2 https://github.com/fortran-lang/fpm/releases/download/v0.12.0/fpm-0.12.0-linux-x86_64-gcc-12; then
            chmod +x fpm-0.12.0-linux-x86_64-gcc-12
            sudo mv fpm-0.12.0-linux-x86_64-gcc-12 /usr/local/bin/fpm
            fpm --version
            break
          else
            echo "FPM download failed, attempt $i"
            sleep 10
            if [ $i -eq 3 ]; then
              echo "All FPM download attempts failed"
              exit 1
            fi
          fi
        done

    - name: Test FPM dependency integration
      run: |
        cd example/user_compilation_examples/fpm_project_template
        fpm build
        fpm run fpm_template_demo

    - name: Verify FPM demo outputs
      run: |
        cd example/user_compilation_examples/fpm_project_template
        ls -la fpm_*.png fpm_*.pdf fpm_*.txt
